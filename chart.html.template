<!DOCTYPE html>
<html>
<head>
    <title>Synchronized + Zoomable Candlestick & Z-Score</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
		<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
</head>
<body>
    <canvas id="candleChart" width="1600" height="500"></canvas>
    <canvas id="zscoreChart" width="1600" height="400"></canvas>
    <script>
        const candleData = {{.CandleData}};
        const zData = {{.ZData}};
        const vwzData = {{.VWZData}};
				// timezone ë³´ì •: ë¸Œë¼ìš°ì €ê°€ ë¡œì»¬ë¡œ í‘œì‹œí•˜ê¸° ë•Œë¬¸ì— offsetì„ ë”í•´ í™”ë©´ìƒ ì‹œê°„ì„ ì›ë³¸ê³¼ ê°™ê²Œ ë§Œë“ ë‹¤.
const tzOffsetMs = new Date().getTimezoneOffset() * 60 * 1000; // ì˜ˆ: KSTì´ë©´ -540000 (getTimezoneOffsetì€ ë¶„ ë‹¨ìœ„, KSTì´ë©´ -540)
candleData.forEach(d => { if (typeof d.x === 'number') d.x = d.x + tzOffsetMs; });
zData.forEach(d => { if (typeof d.x === 'number') d.x = d.x + tzOffsetMs; });
vwzData.forEach(d => { if (typeof d.x === 'number') d.x = d.x + tzOffsetMs; });

        const crosshairPlugin = {
            id: 'crosshair',
            afterDraw: (chart) => {
                if (chart.tooltip?._active?.length) {
                    const ctx = chart.ctx;
                    const x = chart.tooltip._active[0].element.x;
                    const topY = chart.chartArea.top;
                    const bottomY = chart.chartArea.bottom;
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(x, topY);
                    ctx.lineTo(x, bottomY);
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                    ctx.stroke();
                    ctx.restore();
                }
            }
        };
        Chart.register(crosshairPlugin);

        const ctxCandle = document.getElementById('candleChart').getContext('2d');
        const ctxZScore = document.getElementById('zscoreChart').getContext('2d');

        const commonZoom = {
            zoom: {
                wheel: { enabled: true },
                pinch: { enabled: true },
                drag: { enabled: true },
                mode: 'x'
            },
            pan: {
                enabled: true,
                mode: 'x'
            },
            limits: {
                x: { minRange: 1000 * 60 * 5 } // ìµœì†Œ 5ë¶„
            }
        };

        const candleChart = new Chart(ctxCandle, {
            type: 'candlestick',
            data: {
                datasets: [{
                    label: 'SOL/USDT',
                    data: candleData,
                }]
            },
            options: {
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: true, position: 'top' },
                    zoom: commonZoom
                },
                scales: {
                    x: {
											type: 'time',
											time: {
													unit: 'minute',
													displayFormats: {
															minute: 'MM-dd HH:mm',
															hour: 'MM-dd HH:mm'
													},
													tooltipFormat: 'MM-dd HH:mm',
													// zone: 'utc'  // âœ… ì‹œê°„ëŒ€ë¥¼ UTCë¡œ ê³ ì •
											},
											ticks: {
													source: 'data'
											}
										},
                    y: { beginAtZero: false }
                }
            }
        });

        const zscoreChart = new Chart(ctxZScore, {
						type: 'line',
						data: {
								datasets: [
								  {
										label: 'ZScore',
										data: zData,
										borderColor: 'rgb(255, 99, 132)',
										tension: 0.1, pointRadius: 0
									},
									{
											label: 'VWZScore',
											data: vwzData,
											borderColor: 'rgb(54, 162, 235)',
											tension: 0.1, pointRadius: 0
									}
								]
						},
						options: {
								interaction: { intersect: false, mode: 'index' },
								plugins: {
										legend: { display: true, position: 'top' },
										zoom: commonZoom,
										annotation: {
												annotations: {
												    lineZero: { // âœ… ì¤‘ì•™ì„  ì¶”ê°€
																type: 'line',
																yMin: 0,
																yMax: 0,
																borderColor: 'rgba(100, 100, 100, 0.5)',
																borderWidth: 1,
																borderDash: [4, 4], // ì ì„  íš¨ê³¼ (ì„ íƒì‚¬í•­)
																label: {
																		enabled: true,
																		position: 'end',
																		content: '0'
																}
														},
														linePlus: {
																type: 'line',
																yMin: 1.5,
																yMax: 1.5,
																borderColor: 'rgba(0, 200, 0, 0.7)',
																borderWidth: 1,
																// borderDash: [5, 5],
																label: {
																		enabled: true,
																		position: 'end',
																		content: '+1.5'
																}
														},
														lineMinus: {
																type: 'line',
																yMin: -1.5,
																yMax: -1.5,
																borderColor: 'rgba(200, 0, 0, 0.7)',
																borderWidth: 1,
																// borderDash: [5, 5],
																label: {
																		enabled: true,
																		position: 'end',
																		content: '-1.5'
																}
														}
												}
										}
								},
								scales: {
									x: {
										type: 'time',
										time: {
												unit: 'minute',
												displayFormats: {
															minute: 'MM-dd HH:mm',
															hour: 'MM-dd HH:mm'
												},
												tooltipFormat: 'MM-dd HH:mm',
												// zone: 'utc'  // âœ… ì‹œê°„ëŒ€ë¥¼ UTCë¡œ ê³ ì •
										},
										ticks: {
												source: 'data'
										}
									},
									y: { beginAtZero: false }
								}
						}
				});

        // ðŸ”„ ë‘ ì°¨íŠ¸ ë™ê¸°í™”
        function syncCharts(sourceChart, targetChart, event) {
            const points = sourceChart.getElementsAtEventForMode(event, 'index', { intersect: false }, false);
            if (points.length) {
                const index = points[0].index;
                targetChart.setActiveElements([{ datasetIndex: 0, index }]);
                targetChart.tooltip.setActiveElements([{ datasetIndex: 0, index }], {x: 0, y: 0});
                targetChart.update();
            } else {
                targetChart.setActiveElements([]);
                targetChart.tooltip.setActiveElements([], {x: 0, y: 0});
                targetChart.update();
            }
        }

        document.getElementById('candleChart').addEventListener('mousemove', (e) => syncCharts(candleChart, zscoreChart, e));
        document.getElementById('zscoreChart').addEventListener('mousemove', (e) => syncCharts(zscoreChart, candleChart, e));

        document.getElementById('candleChart').addEventListener('mouseleave', () => {
            candleChart.setActiveElements([]); zscoreChart.setActiveElements([]);
            candleChart.tooltip.setActiveElements([], {x: 0, y: 0});
            candleChart.update(); zscoreChart.update();
        });
        document.getElementById('zscoreChart').addEventListener('mouseleave', () => {
            candleChart.setActiveElements([]); zscoreChart.setActiveElements([]);
            candleChart.tooltip.setActiveElements([], {x: 0, y: 0});
            zscoreChart.tooltip.setActiveElements([], {x: 0, y: 0});
            candleChart.update(); zscoreChart.update();
        });

        // ë”ë¸”í´ë¦­ìœ¼ë¡œ ì¤Œ ë¦¬ì…‹
        document.getElementById('candleChart').addEventListener('dblclick', () => {
            candleChart.resetZoom();
            zscoreChart.resetZoom();
        });
        document.getElementById('zscoreChart').addEventListener('dblclick', () => {
            candleChart.resetZoom();
            zscoreChart.resetZoom();
        });
    </script>
</body>
</html>